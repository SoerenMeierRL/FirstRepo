---
title: "Hands-on Practical: Generalised Additive Models (GAMs) with Bioluminescence"
subtitle: "StatGeoMod2025 — 1.5-hour practical"
author: "Søren Meier"
date: "`r format(Sys.Date(), '%d %B %Y')`"
output:
  html_document:
    self_contained: yes
    toc: true
    toc_depth: 3
editor_options: 
  chunk_output_type: console
---

## Setup

```{r setup, echo=FALSE, message=FALSE}
# Runing options
knitr::opts_chunk$set(echo = TRUE,error=TRUE, message=FALSE)

# Load required packages
library(tidyverse)
library(lme4)
library(lmerTest)
theme_set(theme_bw(base_size = 12))

# Set seed for reproducible results
set.seed(123)
```

## Part A – Loading and Exploring the Data (15 minutes)

### Task A1: Load the Data

**What you'll do**: Load the owl data and convert some variables to the right type for analysis.

```{r A1-LoadData}
# Load the data file - fill in the correct function name
owls <- read_table(file = "Owls.txt")

# Convert categorical variables to factors (R's way of handling categories)
owls <- owls %>%
  mutate(
    FoodTreatment = factor(FoodTreatment),
    SexParent = factor(SexParent),
    Nest = factor(Nest)
  )

# Look at the structure of our data
str(owls)

# Count how many observations we have per nest
owls %>%
  count(Nest) %>%
  arrange(desc(n)) %>%
  print(n = 10)
```

**Questions to answer**:

1.  How many total observations do we have? 599
2.  How many different nests? 27
3.  Which nest has the most observations? Oleyes,with 52 observations.

### Task A2: Transform the Response Variable

**What you'll do**: Create a better version of our outcome variable for analysis.

```{r A2-Transform}
# Create log-transformed version (helps with normality)
# We add 0.5 to handle any zero values
owls <- owls %>%
  mutate(logNeg = log(SiblingNegotiation + 0.5))

# Check if this transformation helps make data more normal
ggplot(owls, aes(x = logNeg)) + 
  geom_histogram(bins = 30) +
  labs(title = "Distribution of Log-Transformed Negotiation Calls")

# QQ plot to check normality
qqnorm(owls$logNeg)
qqline(owls$logNeg)
```

**Questions to answer**:

1.  Does the histogram look approximately bell-shaped? The log transformation made the data look a bit more normally distributed, but the data is still not quite normally distributed, and the many 0-values also skew the data.
2.  In the QQ plot, do most points fall close to the line? Not at all, almost no points fall close to the line - great departure from normality. (but this is not the residuals, so this is not a big problem)

### Task A3: Visualize the Nesting Structure

**What you'll do**: See how different nests respond to arrival time.

```{r A3-Visualize}
# Plot showing relationship between arrival time and negotiation for each nest
ggplot(owls, aes(x = ArrivalTime, y = logNeg, color = Nest)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE) +
  guides(color = "none") +  # Hide legend (too many nests)
  labs(
    x = "Arrival Time", 
    y = "Log(Negotiation Calls)",
    title = "Each colored line represents a different nest"
  )
```

**Questions to answer**:

1.  Do all nests show similar slopes (parallel lines)? There is great variation in the slopes, both in terms of the effect and the direction - there are both positive and negative relationships.
2.  Do some nests have consistently higher negotiation levels than others? Yes, several nest have higher/or lower negotiation levels across the whole Arrival Time range.
3.  What does this suggest about treating all observations as independent? Clearly, observations from the same nests are more similar to each other than would be expected from completely indendepent data points- all observations can NOT be treated as independent.

## Part B – Why We Need Mixed Models (20 minutes)

### Task B1: The Wrong Way - Ignoring Nesting

**What you'll do**: See what happens if we ignore the fact that observations come from different nests.

```{r B1-IgnoreNesting}
# Fit a regular linear model that ignores nesting
simple_model <- lm(logNeg ~ ArrivalTime + SexParent + BroodSize + FoodTreatment, 
                   data = owls)

summary(simple_model)
```

**Question to answer**:

1.  What is the coefficient for ArrivalTime? -0.14318

### Task B2: Another Wrong Way - Separate Analysis for Each Nest

**What you'll do**: Fit separate models for each nest, then try to combine results.

```{r B2-SeparateModels}
# Fit separate regression for each nest
nest_results <- owls %>%
  group_by(Nest) %>%
  do({
    # Fit model for this nest only
    model <- lm(logNeg ~ ArrivalTime, data = .)
    
    # Extract key information
    data.frame(
      slope = coef(model)["ArrivalTime"],
      intercept = coef(model)["(Intercept)"],
      n_obs = nrow(.)
    )
  }) %>%
  ungroup()

# Look at the results
print(nest_results, n = 15)

# Now try to relate slopes to food treatment
# First, get treatment for each nest
nest_treatments <- owls %>%
  distinct(Nest, FoodTreatment)

# Combine with our slope results
combined_results <- nest_results %>%
  left_join(nest_treatments, by = "Nest")


# Test if slopes differ by treatment
slope_model <- lm(slope ~ FoodTreatment, data = combined_results)
summary(slope_model)
```

**Questions to answer**:

1.  Do all nests have the same number of observations? No, the number of observations between nests differ greatly.
2.  Why might this be a problem when trying to compare slopes? Each slope is only supported by the data from a single nest, with some slopes having very little data to support them, creating very unreliable results (or potentially high standard errors) - comparing these different slopes does not give useful information.
3.  What information are we throwing away by doing separate analyses? How the predictor affects the response across all of the Nests.

## Part C – Mixed Effects Models: The Right Way (25 minutes)

### Task C1: Random Intercept Model

**What you'll do**: Fit a mixed model that allows each nest to have its own baseline level.

```{r C1-RandomIntercept}
# Fit mixed model with random intercepts for each nest
# (1 | Nest) means "let each nest have its own intercept"
model_ri <- lmer(logNeg ~ ArrivalTime + SexParent + BroodSize + FoodTreatment + 
                   (1 | Nest),
                 data = owls, 
                 REML = TRUE)

summary(model_ri)
```

**Questions to answer**:

1.  What is the fixed effect coefficient for ArrivalTime? -0.14723
2.  What is the variance between nests? 0.2181
3.  What is the residual variance? 1.3113

### Task C2: Random Intercept + Slope Model

**What you'll do**: Allow each nest to have both its own baseline AND its own response to arrival time.

```{r C2-RandomSlope}
# Fit mixed model with random intercepts AND slopes
# (1 + ArrivalTime | Nest) means "let each nest have its own intercept AND slope for ArrivalTime"
model_ris <- lmer(logNeg ~ ArrivalTime + SexParent + BroodSize + FoodTreatment + 
                    (1 + ArrivalTime | Nest),
                  data = owls, 
                  REML = TRUE)

summary(model_ris)
```

**Questions to answer**:

1.  What is the correlation between random intercepts and slopes? -0.99.
2.  Is this correlation positive or negative? Negative.
3.  What does this correlation mean biologically? Nests with higher baseline number of calls (SiblingNegotiation) will more likely have lower slopes, e.g. will be affected more by increases in ArrivalTime than other nests.

### Task C3: Compare the Two Models

**What you'll do**: Statistically test which model fits better.

```{r C3-CompareModels}
# Compare the two models
anova(model_ri, model_ris)
```

**Questions to answer**:

1.  What is the p-value for the comparison? 0.002917
2.  Which model is significantly better? model_ris with the lowest AIC value of 1903 (-7 compared to model_ri) and with a very low p-value under 0.05.
3.  Should we use random slopes or just random intercepts? Since the best model is model_ris, we should use random slopes in addition to random intercepts.

## Part D – Understanding What Mixed Models Do (15 minutes)

### Task D1: Calculate Intraclass Correlation (ICC)

**What you'll do**: Find out how much observations within the same nest resemble each other.

```{r D1-ICC}
# Extract variance components of the mixed model model
variance_components <- as.data.frame(VarCorr(model_ri))

# Get between-NEST variance
between_nest_var <- variance_components$vcov[variance_components$grp == "Nest"]

# Get within-nest variance  of the mixed model mode
within_nest_var <- sigma(model_ri)^2

# Calculate ICC (Intraclass Correlation Coefficient)
icc <- between_nest_var / (between_nest_var + within_nest_var)

cat("ICC =", round(icc, 3),
"\nThis means", round(icc * 100, 1), "% of variation is between nests")
```

**Questions to answer**:

1.  What is the ICC value? 0.143
2.  What percentage of variation is between nests? 14.3 % of the variation is explained by differences in nests.
3.  Is this a high or low level of clustering? Low level of clustering - only a small percentage of the variation in SiblingNegotiation can be explained by the grouping of observations in nests.

### Task D2: Visualize Model Predictions

**What you'll do**: See how the model makes predictions for population vs individual nests.

```{r D2-Predictions}
# Create data for predictions
pred_data <- tibble(
  ArrivalTime = seq(min(owls$ArrivalTime), max(owls$ArrivalTime), length.out = 100),
  FoodTreatment = factor("Deprived", levels = levels(owls$FoodTreatment)),
  SexParent = factor("Male", levels = levels(owls$SexParent)),
  BroodSize = median(owls$BroodSize)
)

# Population-level prediction (ignoring random effects)
pred_data$population_fit <- predict(model_ris, newdata = pred_data, re.form = NA)

# Create nest-specific predictions
# Create the data frame first
nest_data <- owls |>
  distinct(Nest) |>
  slice_head(n = 10) |>
  crossing(pred_data)

# Then add predictions
nest_predictions <- nest_data |>
  mutate(nest_fit = predict(model_ris, newdata = nest_data, re.form = ~ (1 + ArrivalTime | Nest)))

# Plot
ggplot() +
  geom_point(data = owls, aes(ArrivalTime, logNeg), alpha = 0.3) +
  geom_line(data = nest_predictions, 
            aes(ArrivalTime, nest_fit, group = Nest), 
            alpha = 0.5, color = "blue") +
  geom_line(data = pred_data, 
            aes(ArrivalTime, population_fit), 
            size = 2, color = "red") +
  labs(
    title = "Blue lines = individual nests, Red line = population average",
    x = "Arrival Time",
    y = "Log(Negotiation Calls)"
  )
```

**Questions to answer**:

1.  Do the blue lines (individual nests) vary around the red line (population average)? Yes, the red line is approximately in the middle of all the blue lines.
2.  Where is the variation between nests greatest - at early or late arrival times? At late arrival times.

## Part E – Model Checking (15 minutes)

### Task E1: Check Model Assumptions

**What you'll do**: Make sure our model is reasonable by checking the residuals.

```{r E1-Diagnostics}
# Choose our final model (let's assume random slopes was better)
final_model <- model_ris

# Get standardized residuals
residuals <- resid(final_model, type = "pearson")

# 1. Residuals vs fitted values
fitted_values <- fitted(final_model)
ggplot(data.frame(fitted = fitted_values, resid = residuals), 
       aes(fitted, resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red") +
  labs(title = "Residuals vs Fitted - should be random scatter around 0")

# 2. Check normality of residuals
qqnorm(residuals, main = "Q-Q Plot - points should follow the line")
qqline(residuals)

# 3. Check residuals by nest
data.frame(Nest = owls$Nest, residuals = residuals) %>%
  ggplot(aes(fitted_values, residuals, col=Nest)) +
  geom_boxplot() +
  coord_flip() +
  labs(title = "Residuals by nest - should be centered around 0")
```

**Questions to answer**:

1.  In the residuals vs fitted plot, do you see any clear patterns? The residuals are randomly scattered, but residuals around the intermediate range are generally larger, with a pattern of more positive residuals at the lower intermedaite values and more negative residuals at the higher intermediate values.
2.  In the QQ plot, do the residuals appear normally distributed? Many of the residuals follow the line, but deviations can be seen at the tail ends of the data - close to normality of residuals.
3.  Are there any nests with unusual residual patterns? Some nests do not have residuals centered around 0, and also have very small ranges of residual values.

### Task E2: Look at Random Effects

**What you'll do**: See which nests are unusual.

```{r E2-RandomEffects}
# Extract random effects (how each nest differs from average)
random_effects <- ranef(final_model)

# Look at first few
head(random_effects$Nest)

# Make a caterpillar plot of random intercepts
re_data <- as.data.frame(random_effects$Nest) %>%
  mutate(Nest = rownames(.)) %>%
  rename(random_intercept = "(Intercept)")

ggplot(re_data, aes(y = reorder(Nest, random_intercept), x = random_intercept)) +
  geom_point() +
  labs(
    title = "Random intercepts - how much each nest differs from average",
    x = "Nest",
    y = "Random intercept (higher = more negotiation)"
  )
```

**Questions to answer**:

1.  Which nest has the highest random intercept? Bochet.
2.  Which nest has the lowest random intercept? Etrabloz.
3.  What does a positive random intercept mean? That the intercept (baseline number of calls) for a specific nest is higher than the average across all the nests.

## Summary Questions

**Answer these questions based on your analysis**:

1.  Why can't we treat all observations as independent in this dataset?\
    Because many of the observations come from the same nest, which means that these observations will be more similar to each other than observations between nests - therefore, they are not independent observations. For example, the observations from the same nest will have similar conditions and will have genetically related chicks.

2.  What's the main advantage of mixed models over separate analyses for each nest?\
    You can use the mixed model for any nest (you can analyse new nests) and generalise the results of the model across all kinds of nests, whereas seperate analyses for each nests does not allow for generalisation - the model for each nest only describes the pattern for that specific nest.

3.  What does the random intercept capture in our model?\
    The differences in baseline number of calls by chicks (SiblingNegotiation) between nests (compared to the population average) that can be attributed to grouping of observations in these nests.

4.  What does the random slope capture in our model?\
    The differences in the effect of Arrival Time on SiblingNegotiation between nests (compared to the population average) that can be attributed to grouping of observations in these nests.

5.  Based on your model, does arrival time significantly affect sibling negotiation?\
    Yes, as the p-value for the Arrival Time coefficient is very small (0.0009).

6.  Do you think the mixed model approach was necessary for this dataset? Why?\
    Definitely, as the analysis showed a great amount of dependence of observations based on Nests - this grouping of observations in a variable that we are not interested in/are not controlling warrants a mixed model approach that allows for modelling of this random effect.
